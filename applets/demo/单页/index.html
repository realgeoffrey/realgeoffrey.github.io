<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/ico" href="../../../favicon.ico">
    <title>单页</title>
    <link href="../../../src/css/pc.css" type="text/css" rel="stylesheet">
    <link href="css/jquery.fullpage.min.css" type="text/css" rel="stylesheet"><!-- 使用slide才必须加此css-->
    <style>
        body {
            background: rgba(64, 64, 64, .5);
        }
        .loading {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, .8);
            color: #fff;
            display: none;
        }
    </style>
</head>
<body>

<div id="j-fullpage">
    <div class="section" data-anchor="loading">
        ajax-loading
    </div>
</div>

<div class="loading" id="j-loading">
    loading...
</div>

<script id="j-tpl-section" type="text/html">
    <%for(var i = 0; i< sectionArr.length; i++) {%>
    <div class="section" data-anchor="<%=sectionArr[i].id%>">
        <%for(var j = 0; j< sectionArr[i].slide.length; j++) {%>
        <div class="slide">
            <%= sectionArr[i].slide[j].text%>
            <img src="<%=sectionArr[i].slide[j].img%>"/>
        </div>
        <%}%>
    </div>
    <%}%>
</script>

<!-- 测试数据-->
<script type="text/javascript" src="../../../js/mock-min.js"></script>
<script>
    Mock.setup({timeout: '10-1000'});

    Mock.mock(new RegExp('testUrl'), {
        'code': 200,
        'next': '@string(5, 10)',
        'result|1-3': [{
            'id|+1': 1,
            'slide|2-6': [{
                'text': '@cword(1,30)',
                'img': '@dataImage()'
            }]
        }]
    });
</script>
<!--/测试数据-->

<!--<script type="text/javascript" src="js/jquery.min.1.7.2.js"></script>-->
<script type="text/javascript" src="../../../js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="js/jquery.fullpage.min.js"></script>
<script type="text/javascript" src="js/baiduTemplate.js"></script>
<script>
    var globalObj = {
        isAjaxing: false,
        isTouch: (function () { /* 是否是触屏设备*/
            return navigator.userAgent.match(/(iPhone|iPod|iPad|Android|playbook|silk|BlackBerry|BB10|Windows Phone|Tizen|Bada|webOS|IEMobile|Opera Mini)/) || (('ontouchstart' in window) || (navigator.msMaxTouchPoints > 0) || (navigator.maxTouchPoints));
        }()),
        isLoading: function (boolean) { /* 是否正在加载*/
            var $loading = $('#j-loading');

            globalObj.isAjaxing = boolean;

            if (boolean) {
                $loading.show();
                if (typeof $.fn.fullpage.setAllowScrolling === 'function' && typeof $.fn.fullpage.setKeyboardScrolling === 'function') {
                    $.fn.fullpage.setAllowScrolling(false);
                    $.fn.fullpage.setKeyboardScrolling(false);
                }
            } else {
                $loading.hide();
                if (typeof $.fn.fullpage.setAllowScrolling === 'function' && typeof $.fn.fullpage.setKeyboardScrolling === 'function') {
                    $.fn.fullpage.setAllowScrolling(true);
                    $.fn.fullpage.setKeyboardScrolling(true);
                }
            }
        },
        ajaxLoad: function (para) {
            var myself = arguments.callee;

            if (!globalObj.isAjaxing) {
                globalObj.isLoading(true);

                $.ajax({
                    url: 'testUrl',
                    dataType: 'json',
                    data: {
                        para: para
                    }
                }).done(function (data) {
                    if (typeof $.fn.fullpage.destroy === 'function') {
                        $.fn.fullpage.destroy('all');
                    }
                    $('[data-anchor=loading]').before(baidu.template('j-tpl-section', {sectionArr: data.result}));
                    if (globalObj.isTouch) {
                        window.history.replaceState(undefined, undefined, '#');
                    } else {
                        window.location.replace('#');
                    }

                    $('#j-fullpage').fullpage({
                        navigation: true,
                        slidesNavigation: true,

                        animateAnchor: false,
                        recordHistory: false,
                        afterLoad: function (anchorLink, index) {
                            if (anchorLink === 'loading') {
                                myself(data.next);
                            }
                        },
                        onLeave: function (index, nextIndex, direction) {

                        }
                    });
                    $.fn.fullpage.silentMoveTo(data.result[0].id);
                }).fail(function () {
                    console.log('网络错误');
                }).always(function () {
                    globalObj.isLoading(false);
                })
            }
        }
    };

    $(function () {
        globalObj.ajaxLoad(window.location.hash);
    });
</script>
</body>
</html>